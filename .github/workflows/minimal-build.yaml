name: Minimal Windows Build
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: win64
          
      - name: Install OpenSSL
        run: |
          choco install openssl --quiet --yes
          
          # Find the actual OpenSSL installation path
          $openssl_path = Get-ChildItem "C:\Program Files" | Where-Object {$_.Name -like "*OpenSSL*"} | Select-Object -First 1 -ExpandProperty FullName
          if (-not $openssl_path) {
            $openssl_path = "C:\Program Files\OpenSSL-Win64"
          }
          
          echo "OpenSSL installed at: $openssl_path"
          echo "OPENSSL_ROOT_DIR=$openssl_path" >> $env:GITHUB_ENV
          
          # Verify the installation
          if (Test-Path "$openssl_path\include\openssl\opensslv.h") {
            echo "✅ OpenSSL headers found"
          } else {
            echo "❌ OpenSSL headers not found"
            exit 1
          }
          
      - name: Install Ninja
        run: choco install ninja --quiet --yes
        
      - name: Build OQS Provider
        run: |
          echo "Using OpenSSL at: $env:OPENSSL_ROOT_DIR"
          
          mkdir build
          cd build
          
          cmake -GNinja `
            -DCMAKE_BUILD_TYPE=Release `
            -DOQS_MINIMAL_BUILD=ON `
            -DBUILD_SHARED_LIBS=OFF `
            -DBUILD_TESTING=OFF `
            -DOPENSSL_ROOT_DIR="$env:OPENSSL_ROOT_DIR" `
            -DOPENSSL_INCLUDE_DIR="$env:OPENSSL_ROOT_DIR\include" `
            -DOPENSSL_CRYPTO_LIBRARY="$env:OPENSSL_ROOT_DIR\lib\libcrypto.lib" `
            -DOPENSSL_SSL_LIBRARY="$env:OPENSSL_ROOT_DIR\lib\libssl.lib" `
            ..
            
          ninja oqsprov
          
      - name: Create Artifact Directory
        run: |
          mkdir artifacts
          Copy-Item "build\oqsprov\oqsprov.dll" -Destination "artifacts\"
          
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: oqs-provider-windows-minimal
          path: artifacts\
          retention-days: 7
